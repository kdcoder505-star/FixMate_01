<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Firebase Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Config -->
    <script src="js/firebase-config.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            padding: 40px;
        }

        .card {
            max-width: 600px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">FixMate - Firebase Setup</h4>
        </div>
        <div class="card-body">
            <p class="text-secondary">
                Use this tool to create the initial Admin and Student accounts in your Firebase project.
                This allows you to log in immediately.
            </p>

            <div class="alert alert-info small">
                <strong>Prerequisite:</strong> Ensure "Email/Password" Auth and "Firestore" are enabled in your console.
            </div>

            <button id="seedBtn" class="btn btn-success w-100 py-2 fw-bold mb-3">
                <i class="fas fa-play"></i> Seed Database
            </button>

            <a href="login.html" class="btn btn-outline-primary w-100">
                Go to Login Page
            </a>

            <hr>
            <h6>Log Output:</h6>
            <div id="logs" class="log-area">Ready...</div>
        </div>
    </div>

    <script>
        // Initialize
        firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const logger = document.getElementById('logs');
        function log(msg, type = 'info') {
            const color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#51cf66' : '#00ff00');
            logger.innerHTML += `<div style="color:${color}; margin-bottom:4px;">> ${msg}</div>`;
            logger.scrollTop = logger.scrollHeight;
        }

        const USERS = [
            {
                email: 'admin@college.edu',
                password: 'password',
                role: 'admin',
                full_name: 'Dr. Sarah Smith',
                department: 'Administration'
            },
            {
                email: 'student@college.edu',
                password: 'password',
                role: 'student',
                full_name: 'James Carter',
                department: 'Computer Science'
            },
            {
                email: 'emily.r@college.edu',
                password: 'password',
                role: 'student',
                full_name: 'Emily Rose',
                department: 'Physics'
            },
            {
                email: 'staff@college.edu',
                password: 'password',
                role: 'staff',
                full_name: 'Mike Builder',
                department: 'Facilities'
            }
        ];

        // Helper to delay
        const delay = ms => new Promise(res => setTimeout(res, ms));

        document.getElementById('seedBtn').addEventListener('click', async () => {
            log('Starting seeding process...', 'info');

            try {
                // 1. Create Users
                const userIds = {};

                for (const u of USERS) {
                    log(`Processing user: ${u.email}...`);
                    let uid;

                    // Try to Login first
                    try {
                        const cred = await auth.signInWithEmailAndPassword(u.email, u.password);
                        uid = cred.user.uid;
                        log(`  - User exists (UID: ${uid.substring(0, 5)}...)`, 'success');
                    } catch (e) {
                        try {
                            // If login fails (assume not found), try create
                            const cred = await auth.createUserWithEmailAndPassword(u.email, u.password);
                            uid = cred.user.uid;

                            // Update display name
                            await cred.user.updateProfile({ displayName: u.full_name });

                            log(`  - Created new user (UID: ${uid.substring(0, 5)}...)`, 'success');
                        } catch (createErr) {
                            log(`  - Error creating ${u.email}: ${createErr.message}`, 'error');
                            continue;
                        }
                    }

                    userIds[u.email] = uid;

                    // Save to Firestore 'users' collection
                    await db.collection('users').doc(uid).set({
                        email: u.email,
                        role: u.role,
                        full_name: u.full_name,
                        department: u.department || null,
                        created_at: new Date().toISOString()
                    }, { merge: true });

                    log(`  - Firestore profile updated.`, 'success');

                    // Sign out to prepare for next (or just to be clean)
                    await auth.signOut();
                    await delay(500);
                }

                // 2. Create Dummy Complaints
                log('Seeding complaints...');
                const studentId1 = userIds['student@college.edu'];
                const studentId2 = userIds['emily.r@college.edu'];

                const COMPLAINTS = [
                    {
                        title: 'WiFi Down in Library',
                        description: 'The WiFi signal on the 3rd floor of the library is completely dead.',
                        category: 'IT Services',
                        priority: 'High',
                        status: 'In Progress',
                        student_id: studentId1,
                        updated_by: studentId1
                    },
                    {
                        title: 'Leaking Tap in Dorm B',
                        description: 'Sink in room 204 is leaking.',
                        category: 'Facilities',
                        priority: 'Medium',
                        status: 'Pending',
                        student_id: studentId2, // Emily
                        updated_by: studentId2
                    },
                    {
                        title: 'Projector Malfunction',
                        description: 'Hall 3 projector flickers.',
                        category: 'Academic',
                        priority: 'High',
                        status: 'Pending',
                        student_id: studentId1,
                        updated_by: studentId1
                    }
                ];

                for (const c of COMPLAINTS) {
                    if (!c.student_id) continue;

                    // Add to firestore
                    const docRef = await db.collection('complaints').add({
                        ...c,
                        created_at: new Date().toISOString()
                    });

                    // Add initial history
                    await db.collection('complaint_history').add({
                        complaint_id: docRef.id,
                        status: c.status,
                        comment: 'Complaint filed.',
                        updated_by: c.student_id,
                        created_at: new Date().toISOString()
                    });
                }

                log('Complaints seeded successfully.', 'success');
                log('âœ… ALL DONE! You can now log in.', 'success');

            } catch (err) {
                console.error(err);
                log(`CRITICAL ERROR: ${err.message}`, 'error');
            }
        });
    </script>
</body>

</html>